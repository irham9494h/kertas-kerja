const sbTgl=window.location.origin+"/sb-tgl/",sbUrl=window.location.origin+"/kertas-kerja/",pendapatanUrl=window.location.origin+"/sb-tgl/pendapatan/",belanjaUrl=window.location.origin+"/sb-tgl/belanja/",confirmDelete={title:"Apakah Anda yakin?",text:"Data yang telah dihapus tidak dapat dikembalikan dan Anda akan kehilangan HISTORY dari kertas kerja Anda!",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Ya, hapus sekarang!",cancelButtonText:"Tidak, batal hapus!",reverseButtons:!0};let oldNominal=0,tanggalKertasKerja=0,tanggalIDKertasKerja=0;function successSwal(a){return Swal.fire("Berhasil!",a,"success")}function errorSwal(a){return Swal.fire("Gagal!",a,"error")}function showError(a,t){$.each(a,function(a,e){$("#"+t).find($("input[name="+a+"]")).addClass("is-invalid"),$("#"+t).find($("#"+a+"_feedback")).text(e)})}function myDateFormat(a){var t=new Date(a.toString().split("/").reverse().join("-"));return("0"+t.getDate()).slice(-2)+"/"+("0"+(t.getMonth()+1)).slice(-2)+"/"+t.getFullYear()}function formatRupiah(a){return AutoNumeric.format(a,{digitGroupSeparator:".",decimalCharacter:",",decimalCharacterAlternative:"."})}function deleteTanggalKertasKerja(a){Swal.fire(confirmDelete).then(t=>{t.value&&$.ajax({type:"GET",url:sbTgl+"delete/"+a,dataType:"json",success:function(t){t.status?(successSwal(t.message),$(".btn-kertas-kerja-g:nth-last-of-type(2)").append('<button type="button" class="btn btn-xs btn-outline-danger" id="btnDeleteTanggal" onclick="deleteTanggalKertasKerja('+$(".btn-kertas-kerja-g:nth-last-of-type(2)").data("tanggal-id")+')"><i class="fa fa-times"></i></button>'),$("#tglKertasKerja"+a).remove()):errorSwal(t.message)}})})}function fetchKertasKerja(a,t){$("#cardKertasKerja").hide(),$("#cardKertasKerja").show(),$("#pendapatanContentTable").html(""),$("#noDataPendapatan").hide(),$("#itemKertasKerjaLoader").append('<div class="d-flex justify-content-center"><div class="lds-ellipsis"><div></div><div></div><div></div><div></div></div></div>'),$("#kertasKerjaTanggalTitle").text(myDateFormat(a)),$("#btnTambahBelanja").hide().data("belanja-tanggal-id",t),$("#btnTambahPembiayaan").hide(),$("#btnTambahPendapatan").show().data("pendapatan-tanggal-id",t),tanggalIDKertasKerja=t,tanggalKertasKerja=a,$(".btn-kertas-kerja").removeClass("btn-dark").addClass("btn-outline-dark"),$("#btnFetchKertasKerja"+t).removeClass("btn-outline-dark").addClass("btn-dark"),$.ajax({type:"GET",url:pendapatanUrl+t+"/all",dataType:"json",success:function(a){$("#itemKertasKerjaLoader").html("");var t="",e="",n=0;if(a.data.length>0){for(e="",i=0;i<a.opd.length;i++)e+='<div class="d-flex p-2 opd">',e+='<p class="mb-0">'+a.opd[i].bidang.urusan.kode+"."+a.opd[i].bidang.kode+"."+a.opd[i].kode+" "+a.opd[i].nama_unit+"</p>",e+='<p class="mb-0 ml-auto" id="total'+a.opd[i].id+'">Rp. <span id="totalNilai'+a.opd[i].id+'">0</span></p>',e+="</div>",e+='<div class="mb-2 pb-0" id="opd'+a.opd[i].id+'">',e+="</div>";for($("#pendapatanContentTable").append(e),i=0;i<a.data.length;i++){for(n=0,t="",t+='<table class="w-100 table table-sm mb-0">',t+="<thead>",t+="<tr>",t+="<th>Uraian</th>",t+="<th>Nilai</th>",t+="</tr>",t+="</thead>",t+='<tbody id="tblOpd'+a.data[i].unit_id+'">',j=0;j<a.data[i].list_uraian.length;j++)t+="<tr>",t+='<td style="width: 80%">'+a.data[i].list_uraian[j].uraian+"</td>",t+='<td style="text-align: end; width: 20%; padding-right: 0.5rem !important;"><a href="#" class="text-dark nominal" id="item'+a.data[i].list_uraian[j].id+'" onclick="editItem('+a.data[i].list_uraian[j].id+","+a.data[i].list_uraian[j].nilai+', event)">'+formatRupiah(a.data[i].list_uraian[j].nilai)+"</a></td>",t+="</tr>",n+=a.data[i].list_uraian[j].nilai;t+="</tbody>",t+="</table>",$("#opd"+a.data[i].unit_id).html(t),$("#totalNilai"+a.data[i].unit_id).html(formatRupiah(n)).attr("data-total"+a.data[i].unit_id,n)}$("#noDataPendapatan").hide(),$("#tblPendapatan").show()}else $("#tblPendapatan").hide(),$("#bodyTblPendapatan").html(""),$("#noDataPendapatan").show()}})}function editItem(a,t,e){e.preventDefault(),$("#newNominal").val(""),$("#kertasKerjaId").val(a),formatedNominal.set(t),oldNominal=formatedNominal.getNumber(),$("#modalNominal").modal("show")}function fetchKertasKerjaBelanja(a){$("#belanjaContentTable").html(""),$("#noDataBelanja").hide(),$("#itemKertasKerjaBelanjaLoader").append('<div class="d-flex justify-content-center"><div class="lds-ellipsis"><div></div><div></div><div></div><div></div></div></div>'),$("#btnTambahPendapatan").hide(),$("#btnTambahPembiayaan").hide(),$("#btnTambahBelanja").show().data("belanja-tanggal-id",a),$.ajax({type:"GET",url:belanjaUrl+a+"/all",dataType:"json",success:function(a){$("#itemKertasKerjaBelanjaLoader").html("");var t="";if(a.opd.length>0){for(t="",i=0;i<a.opd.length;i++)t+='<div class="d-flex p-2 opd">',t+='<p class="mb-0">'+a.opd[i].bidang.urusan.kode+"."+a.opd[i].bidang.kode+"."+a.opd[i].kode+" "+a.opd[i].nama_unit+"</p>",t+='<p class="mb-0 ml-auto" id="total'+a.opd[i].id+'">Rp. <span id="totalNilai'+a.opd[i].id+'">0</span></p>',t+="</div>",t+='<div class="mb-2 pb-0" id="opd'+a.opd[i].id+'">',t+="</div>";$("#belanjaContentTable").append(t),$("#noDataBelanja").hide(),$("#tblBelanja").show()}else $("#tblBelanja").hide(),$("#bodyTblBelanja").html(""),$("#noDataBelanja").show()}})}$(function(){$("#tanggal").daterangepicker({singleDatePicker:!0,showDropdowns:!0,locale:{format:"DD/MM/YYYY",separator:" - ",applyLabel:"Apply",cancelLabel:"Cancel",fromLabel:"From",toLabel:"To",customRangeLabel:"Custom",weekLabel:"W",daysOfWeek:["Ming","Sen","Sel","Rab","Kam","Jum","Sab"],monthNames:["Januari","Februari","Maret","April","Mei","Juni","Juli","Augustus","September","Oktober","November","Desember"],firstDay:1}}),$("#opdPendapatan").select2(),$("#rekeningPendapatan").select2(),$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),$("form").on("focus","input[type=number]",function(a){$(this).on("wheel.disableScroll",function(a){a.preventDefault()})}),$("form").on("blur","input[type=number]",function(a){$(this).off("wheel.disableScroll")}),$("#btnTambahSbTanggal").on("click",function(a){a.preventDefault(),$("#modalFormTanggal").text("Form Tambah Kertas Kerja"),$("#btnSimpanTanggal").show(),$("#btnSimpanUbahTanggal").hide(),$("#tahunId").val($(this).data("tahun-id")),$("#modalTanggal").modal("show")}),$("#btnSimpanTanggal").on("click",function(a){a.preventDefault();var t="";$.ajax({type:"POST",url:sbTgl+"store",dataType:"json",data:$("#formTanggal").serialize(),success:function(a){console.log(a),a.status?($("#btnDeleteTanggal").remove(),t="",t+=' <div class="btn-group btn-group-xs" role="group" id="tglKertasKerja'+a.data.id+'">',t+='<a href="'+window.location.origin+"/sb/t/"+a.data.sd_tahun_id+"/kertas-kerja/d/"+a.data.id+'/list" class="btn btn-xs btn-outline-dark btn-kertas-kerja" id="btnFetchKertasKerja'+a.data.id+'">'+myDateFormat(a.data.tanggal)+"</a>",t+='<button type="button" class="btn btn-xs btn-outline-danger" id="btnDeleteTanggal" data-tanggal-id="'+a.data.id+'" onclick="deleteTanggalKertasKerja('+a.data.id+')"><i class="fa fa-times"></i></button>',t+="</div>",$("#buttonBar").append(t),successSwal("Berhasil menambah tanggal kertas kerja."),$("#modalTanggal").modal("hide")):showError(a.error,"formTanggal")},error:function(a){errorSwal(a.responseJSON.message)}},"json")})}),$("#btnTambahPendapatan").on("click",function(){$("#formItemPendapatan").trigger("reset"),$("#modalFormItemKertasKerja").text("Form Tambah Kertas Kerja Pendapatan"),$("#pendapatanTanggalId").val($(this).data("pendapatan-tanggal-id")),$("#modalItemPendapatan").modal("show")}),$("#btnTambahBelanja").on("click",function(){$("#modalFormBelanja").text("Form Tambah Kertas Kerja Belanja"),$("#tanggalId").val($(this).data("tanggal-id")),$("#modalItemBelanjan").modal("show")}),$("#pendapatan-tab").on("click",function(a){a.preventDefault(),fetchKertasKerja(tanggalKertasKerja,tanggalIDKertasKerja)}),$("#btnSimpanItemPendapatan").on("click",function(a){a.preventDefault();$.ajax({type:"POST",url:pendapatanUrl+"store",dataType:"json",data:$("#formItemPendapatan").serialize(),success:function(a){var t="";a.status&&($("#pendapatanContentTable").children().length>0?$("#opd"+a.data.unit_id).children().length>0?(t="",t+="<tr>",t+='<td style="width: 80%">'+a.data.uraian+"</td>",t+='<td style="text-align: end; width: 20%; padding-right: 0.5rem !important;"><a href="#" class="text-dark nominal" onclick="editItem('+a.data.id+", "+a.data.nilai+', event)">'+formatRupiah(a.data.nilai)+"</a></td>",t+="</tr>",$("#tblOpd"+a.data.unit_id).append(t),newTotal=parseInt($("#totalNilai"+a.data.unit_id).data("total"))+parseInt(a.data.nilai),$("#totalNilai"+a.data.unit_id).html(formatRupiah(newTotal)).attr("data-total"+a.data.unit_id,newTotal)):(t="",t+='<table class="w-100 table table-sm mb-0">',t+="<thead>",t+="<tr>",t+="<th>Uraian</th>",t+="<th>Nilai</th>",t+="</tr>",t+="</thead>",t+='<tbody id="tblOpd'+a.data.unit_id+'">',t+="<tr>",t+='<td style="width: 80%">'+a.data.uraian+"</td>",t+='<td style="text-align: end; width: 20%; padding-right: 0.5rem !important;"><a href="#" class="text-dark nominal" id="item'+a.data.id+'" onclick="editItem('+a.data.id+", "+a.data.nilai+', event)">'+formatRupiah(a.data.nilai)+"</a></td>",t+="</tr>",t+="</tbody>",t+="</table>",$("#opd"+a.data.unit_id).html(t),$("#totalNilai"+a.data.unit_id).html("Rp. "+formatRupiah(a.data.nilai)).attr("data-total"+a.data.unit_id,a.data.nilai)):fetchKertasKerja($("#kertasKerjaTanggalTitle").text(),$("#pendapatanTanggalId").val()),$("#modalItemPendapatan").modal("hide"),successSwal("Berhsail"))}})}),$("#btnSimpanUbahNominal").on("click",function(a){a.preventDefault();var t=formatedNominal.getNumber();$.ajax({type:"POST",url:sbTgl+"pendapatan/update-nominal",dataType:"json",data:{new_nominal:t,uraian_id:$("#kertasKerjaId").val()},success:function(a){console.log(a),tot=new AutoNumeric("#totalNilai"+a.data.unit_id,{digitGroupSeparator:".",decimalCharacter:",",decimalCharacterAlternative:"."});var e=0,n=0;a.status?(successSwal(a.message),$("#modalNominal").modal("hide"),e=tot.getNumber(),oldNominal>a.data.nilai?(n=oldNominal-t,console.log("> "+oldNominal+", "+t+", "+n+", "+e+", "+(e-n)),$("#totalNilai"+a.data.unit_id).html(formatRupiah(e-n)).attr("data-total",e-n)):oldNominal<t&&(n=a.data.nilai-oldNominal,console.log("< "+oldNominal+", "+t+", "+n+", "+e+", "+(e+n)),$("#totalNilai"+a.data.unit_id).html(formatRupiah(e+n)).attr("data-total",e+n)),$("#item"+a.data.id).attr("onclick","editItem("+a.data.id+", "+t+", event)").text(formatRupiah(t))):errorSwal(a.message)},error:function(a){errorSwal(a.responseJSON.message)}},"json")}),$("#belanja-tab").on("click",function(a){a.preventDefault(),fetchKertasKerjaBelanja(tanggalIDKertasKerja)});
